# Wazuh Stack 4.3.X

On this folder we can find to types of environments:

 * release environment, managed by the `rel.sh` script
 * prerelease environment managed by the `pre.sh` script

## Release environment

This environment will start a working deployment with:
  - wazuh manager
  - wazuh indexer
  - wazuh dashboard

Supported Wazuh versions:

	- 4.3.4
	- 4.3.3
	- 4.3.2
	- 4.3.1
	- 4.3.0

The images used here are generated by the CI/CD team and uploaded into
the official Docker Hub organization.


### Image certificates

Certificates are created automatically by the docker-compose, but if
it fails to create them with the apropriate permissions, we might need
to adjust them.

This is related to the way the official Wazuh docker images are
prepared.

### Registering agents using other docker images

To register an agent, we need to get the registering command from the
UI and then execute:

For centos/8 images:

    $ docker run --rm --network wzd-pro-4.3.4 -d centos:8 bash -c '
    	sed -i -e "s|mirrorlist=|#mirrorlist=|g" /etc/yum.repos.d/CentOS-*
    	sed -i -e "s|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g" /etc/yum.repos.d/CentOS-*

    	# Change this command by the one the UI suggest to use add it the -y and remove the sudo
    	WAZUH_MANAGER='wazuh.manager' yum install -y https://packages.wazuh.com/4.x/yum5/x86_64/wazuh-agent-4.3.4-1.el5.x86_64.rpm

    	/etc/init.d/wazuh-agent start
    	tail -f /var/ossec/logs/ossec.log
	'

For ubuntu images

    $ docker run --network wzd-pro-4.3.4 -d ubuntu:20.04 bash -c '
    	apt update -y
    	apt install -y curl lsb-release
    	# Change this command by the one the UI suggest to use add it tremove the sudo
    	curl -so wazuh-agent-4.3.4.deb https://packages.wazuh.com/4.x/apt/pool/main/w/wazuh-agent/wazuh-agent_4.3.4-1_amd64.deb && WAZUH_MANAGER='wazuh.manager' dpkg -i ./wazuh-agent-4.3.4.deb

    	/etc/init.d/wazuh-agent start
    	tail -f /var/ossec/logs/ossec.log
	'

For non linux agents:

We need to provision virtual machines.

## Prerelease environment

The prerelease environment help us test app releases while the rest of
Wazuh packages haven't been generated yet.

This environment will bring up:

 - wazuh indexer
 - wazuh dashboard
 - Filebeat
 - Imposter

### Usage

```
./pre.sh wazuh_version wazuh_api_version action

where
  wazuh_version is one of
  wazuh_api_version is the minor version of wazuh 4.3, for example  5 17
  action is one of up | down

In a minor release, the API should not change the version here bumps the API
 string returned for testing. This script generates the file

    config/imposter/api_info.json

used by the mock server
```

Please take into account that the api version for this environment will always be a 4.3.X version. Also consider that our application version must be the same as the one selected here.

### Install a compatible wazuh

The same approach used by the production environment is used in the pre-release package.

### Agent registrations

Because we're not using a real wazuh-manager, we cannot registrate new agents, but the mock server wil generate data to valid API requests as i it were the real wazuh server.
